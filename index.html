<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>POT Buyback Portal</title>

<script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js"></script>

<style>
    body {
        margin: 0;
        min-height: 100vh;
        background: linear-gradient(135deg, #030b17, #0b1120, #111827);
        display: flex;
        justify-content: center;
        align-items: center;
        font-family: Arial, sans-serif;
        color: white;
    }

    .card {
        width: 90%;
        max-width: 450px;
        background: rgba(15, 23, 42, 0.95);
        padding: 30px;
        border-radius: 20px;
        text-align: center;
        box-shadow: 0 0 30px rgba(0, 0, 0, 0.4);
    }

    img {
        width: 120px;
        border-radius: 20px;
    }

    input {
        width: 100%;
        padding: 12px;
        border-radius: 10px;
        border: none;
        margin-top: 10px;
        font-size: 16px;
    }

    button {
        width: 100%;
        padding: 14px;
        margin-top: 18px;
        background: #16a34a;
        border: none;
        color: white;
        font-size: 18px;
        border-radius: 12px;
        cursor: pointer;
    }

    button:disabled {
        background: #555;
        cursor: not-allowed;
    }

    .info {
        margin-top: 8px;
        font-size: 14px;
        opacity: 0.8;
    }
</style>
</head>
<body>

<div class="card">

    <img src="https://i.postimg.cc/4dJ4rH4H/panda-logo.png">

    <h2>POT Buyback Portal</h2>
    <div style="margin-top:-10px; opacity:0.7;">
        Playtopia Organization Token (POT)
    </div>

    <button id="connectBtn">Connect Wallet</button>

    <div id="walletBox" style="margin-top:10px; font-size:14px; display:none;">
        Connected: <span id="userAddress"></span>
    </div>

    <h3 style="margin-top:25px;">Amount of POT to sell</h3>

    <input id="amount" type="number" placeholder="e.g. 10000">

    <div class="info">Buyback Price: <span id="priceTxt">Loading...</span></div>
    <div class="info">Estimated Receive: <span id="receiveTxt">0</span> USDT</div>

    <button id="sellBtn" disabled>Sell POT for USDT</button>

    <div id="errorBox" style="margin-top:15px; color:#ff6961; font-size:14px;"></div>

</div>

<script>
const CONTRACT_ADDRESS = "0x9652CC7355C759DB295E8bd5A21d4D707FC07085";

const ABI = [
{"inputs":[{"internalType":"address","name":"_token","type":"address"},{"internalType":"address","name":"_usdt","type":"address"}],"stateMutability":"nonpayable","type":"constructor"},
{"inputs":[],"name":"owner","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},
{"inputs":[],"name":"price","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
{"inputs":[{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"sellTokens","outputs":[],"stateMutability":"nonpayable","type":"function"},
{"inputs":[{"internalType":"uint256","name":"newPrice","type":"uint256"}],"name":"setPrice","outputs":[],"stateMutability":"nonpayable","type":"function"},
{"inputs":[],"name":"token","outputs":[{"internalType":"contract IERC20","name":"","type":"address"}],"stateMutability":"view","type":"function"},
{"inputs":[],"name":"usdt","outputs":[{"internalType":"contract IERC20","name":"","type":"address"}],"stateMutability":"view","type":"function"},
{"inputs":[{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"withdrawTokens","outputs":[],"stateMutability":"nonpayable","type":"function"},
{"inputs":[{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"withdrawUSDT","outputs":[],"stateMutability":"nonpayable","type":"function"}
];

let provider;
let signer;
let contract;

// -------- CONNECT WALLET --------
document.getElementById("connectBtn").onclick = async () => {
    try {
        if (!window.ethereum) {
            alert("MetaMask or Trust Wallet browser required.");
            return;
        }

        provider = new ethers.providers.Web3Provider(window.ethereum);
        await provider.send("eth_requestAccounts", []);
        signer = provider.getSigner();

        const address = await signer.getAddress();
        document.getElementById("userAddress").innerText = address;
        document.getElementById("walletBox").style.display = "block";

        contract = new ethers.Contract(CONTRACT_ADDRESS, ABI, signer);

        loadPrice();
        document.getElementById("sellBtn").disabled = false;

    } catch (err) {
        document.getElementById("errorBox").innerText = err.message;
    }
};

// -------- LOAD PRICE --------
async function loadPrice() {
    try {
        const p = await contract["price"]();
        document.getElementById("priceTxt").innerText = p.toString();
    } catch (err) {
        document.getElementById("priceTxt").innerText = "Error";
        console.log(err);
    }
}

// -------- CALCULATE ESTIMATED RECEIVE --------
document.getElementById("amount").oninput = () => {
    const amt = document.getElementById("amount").value;
    const price = document.getElementById("priceTxt").innerText;

    if (!amt || !price || price === "Loading..." || price === "Error") {
        document.getElementById("receiveTxt").innerText = "0";
        return;
    }

    const result = (amt * price) / 1e18;
    document.getElementById("receiveTxt").innerText = result;
};

// -------- SELL TOKENS --------
document.getElementById("sellBtn").onclick = async () => {
    try {
        document.getElementById("errorBox").innerText = "";

        const amount = document.getElementById("amount").value;
        if (!amount || amount <= 0) {
            document.getElementById("errorBox").innerText = "Enter a valid amount.";
            return;
        }

        const tx = await contract["sellTokens"](ethers.BigNumber.from(amount));
        await tx.wait();

        alert("Sell successful!");

    } catch (err) {
        document.getElementById("errorBox").innerText = err.message;
    }
};
</script>

</body>
</html>
